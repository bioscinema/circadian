% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/scope_screen.R
\name{spectrum_with_detrend}
\alias{spectrum_with_detrend}
\title{Spectrum Analysis with Optional Detrending and Power Correction}
\usage{
spectrum_with_detrend(
  t,
  y,
  detrend = c("diff", "ma", "none"),
  d_order = 1,
  k_ma = NULL,
  method = c("auto", "fft", "lomb"),
  window = c("hann", "rect"),
  correct = TRUE,
  interp_dt = NULL,
  plot = TRUE
)
}
\arguments{
\item{t}{Numeric vector of sampling times.}

\item{y}{Numeric vector of observations (same length as \code{t}).}

\item{detrend}{Character. Detrending mode:
\itemize{
\item \code{"diff"}: apply \eqn{d}-order differencing;
\item \code{"ma"}: apply moving-average (MA) high-pass filtering;
\item \code{"none"}: no detrending.
}}

\item{d_order}{Integer. Differencing order when \code{detrend = "diff"}.}

\item{k_ma}{Integer. Window size for moving-average filter when \code{detrend = "ma"}.
If \code{NULL}, the function automatically chooses an appropriate window length.}

\item{method}{Character. Spectrum estimation method:
\itemize{
\item \code{"auto"}: automatically choose \code{"fft"} for uniform sampling,
otherwise \code{"lomb"};
\item \code{"fft"}: Fast Fourier Transform;
\item \code{"lomb"}: Lomb–Scargle periodogram (requires the \strong{lomb} package).
}}

\item{window}{Character. Window function for FFT. Either \code{"hann"} or \code{"rect"}.}

\item{correct}{Logical. Whether to apply power correction by dividing by
\eqn{|H(\omega)|^2} (detrend filter gain) and coherent window gain.}

\item{interp_dt}{Numeric. Time-step used for interpolation when using FFT
with nonuniform sampling. Defaults to the median time interval.}

\item{plot}{Logical. Whether to return a \code{ggplot2} spectrum plot.}
}
\value{
A list with the following elements:
\describe{
\item{spectrum}{A \code{data.frame} containing frequencies (\code{freq}),
raw power (\code{P_raw}), and corrected power (\code{P_corr}).}
\item{plot}{A \code{ggplot2} object (if \code{plot = TRUE}).}
\item{details}{A list of additional analysis details,
including detrend method, filter parameters, and window corrections.}
}
}
\description{
Compute the power spectrum of a time series with optional detrending
(via differencing or moving-average high-pass filtering), flexible
spectral estimation methods (FFT or Lomb–Scargle), and energy correction
for filter and window effects.
}
\details{
The function first removes missing values, then optionally detrends
the signal. When \code{method = "auto"}, it checks sampling uniformity based
on the median interval deviation.

For FFT-based spectra, it supports Hann and rectangular windows, and applies
coherent gain correction when \code{correct = TRUE}. For nonuniform sampling,
the signal is interpolated to a uniform grid before FFT computation.

The Lomb–Scargle option uses the \pkg{lomb} package to estimate the spectrum
directly from irregular time points. The correction factor \eqn{|H(\omega)|^2}
adjusts the power spectrum to approximate the "true" spectral power after
detrending.
}
\examples{
# Simulate a noisy sinusoidal signal
t <- seq(0, 48, by = 1)
y <- sin(2 * pi * t / 24) + rnorm(length(t), sd = 0.3)

# Compute spectrum using FFT with Hann window
res <- spectrum_with_detrend(t, y, detrend = "diff", method = "fft", window = "hann")
res$plot

# Use Lomb–Scargle method for nonuniform sampling
t2 <- sort(runif(30, 0, 48))
y2 <- sin(2 * pi * t2 / 24) + rnorm(length(t2), 0, 0.3)
res2 <- spectrum_with_detrend(t2, y2, method = "lomb")

}
